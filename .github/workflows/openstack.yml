on: [push]

jobs: 
    build_terraform_docker:
        runs-on: self-hosted
        name: Build Terraform
        steps: 
            - name: Checkout
              uses: actions/checkout@v4
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Build and export
              uses: docker/build-push-action@v5
              with:
                context: ./.github/workflows/openstack/
                tags: github-terraform-docker:latest
                outputs: type=docker,dest=/tmp/github-terraform-docker.tar
            - name: Prep Env for Terraform
              run: |
                export TF_VAR_user="${{ secrets.OS_USERNAME }}"
                export TF_VAR_application_credential_id="${{ secrets.OS_APPLICATION_CREDENTIAL_ID }}"
                export TF_VAR_application_credential_secret="${{ secrets.OS_APPLICATION_CREDENTIAL_SECRET }}"
                export TF_VAR_ssh_access_key="${{ secrets.OS_SSH_KEY }}"
                export TF_VAR_os_auth_region="${{ secrets.OS_AUTH_REGION }}"
                export TF_VAR_os_auth_url="${{ secrets.OS_AUTH_URL }}"
                export TF_VAR_os_project_domain_name="${{ secrets.OS_PROJECT_DOMAIN_NAME }}"
                export TF_VAR_os_password="${{ secrets.OS_PASSWORD }}"
            - name: Upload Docker Image
              uses: actions/upload-artifact@v4
              with:
                name: github-terraform-docker
                path: /tmp/github-terraform-docker.tar

    run_terraform:
        runs-on: self-hosted
        needs: build_terraform_docker
        name: Run Terraform
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Download Docker Image
              uses: actions/download-artifact@v4
              with:
                name: github-terraform-docker
                path: /tmp
            - name: Load Image
              run: |
                docker load --input /tmp/github-terraform-docker.tar
                docker image ls -a
            - name: Terraform Init
              run: terraform init
            - name: Terraform Plan
              run: terraform plan
            - name: Terraform Apply
              run: terraform apply -auto-approve

    destroy_terraform:
        runs-on: self-hosted
        needs: run_terraform
        name: Terraform Destroy
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Run Terraform Destroy
              run: terraform destroy -auto-approve 